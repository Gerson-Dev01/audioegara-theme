{% comment %}
  Secci√≥n: P√°gina de cotizaci√≥n de equipos (AudioEgara) - Versi√≥n Mejorada y Compatible
{% endcomment %}

<section class="cotizacion-page page-width">
  <header class="text-center">
    <h1 class="text-3xl font-bold mb-2">Solicitar Cotizaci√≥n</h1>
    <p class="text-gray-600 mb-6">
      Selecciona los productos que te interesan y env√≠anos tu solicitud. Te responderemos con un presupuesto personalizado.
    </p>
  </header>

  <!-- Controles de b√∫squeda -->
  <div class="cotizacion-controls mb-6 text-center">
    <input type="text" id="product-search" placeholder="üîç Buscar productos..." class="search-input">
  </div>

  <!-- Contador de seleccionados -->
  <div id="selected-counter" class="selected-counter mb-4" style="display: none;">
    <span id="selected-count">0</span> productos seleccionados
    <button id="clear-selection" class="clear-btn">Limpiar selecci√≥n</button>
  </div>

  <!-- Grid de productos -->
  <div id="cotizacion-productos" class="product-grid"></div>

  <!-- Paginaci√≥n -->
  <div class="pagination-controls flex justify-center items-center gap-4 mb-8">
    <button id="prev-page" class="pagination-btn" disabled>‚Äπ Anterior</button>
    <div id="page-numbers" class="page-numbers"></div>
    <button id="next-page" class="pagination-btn">Siguiente ‚Ä∫</button>
  </div>

  <!-- Formulario -->
  <form id="cotizacion-form" class="cotizacion-form">
    <h2 class="text-xl font-semibold mb-4">Datos de contacto</h2>
    
    <div class="form-group">
      <label for="nombre" class="form-label">Nombre completo *</label>
      <input type="text" id="nombre" name="nombre" placeholder="Tu nombre" required class="form-input">
    </div>
    
    <div class="form-group">
      <label for="email" class="form-label">Correo electr√≥nico *</label>
      <input type="email" id="email" name="email" placeholder="Correo electr√≥nico" required class="form-input">
    </div>
    
    <div class="form-group">
      <label for="mensaje" class="form-label">Mensaje adicional</label>
      <textarea id="mensaje" name="mensaje" placeholder="Detalles adicionales o requerimientos espec√≠ficos" class="form-textarea"></textarea>
    </div>
    
    <button type="submit" class="btn btn--primary w-full">Enviar Cotizaci√≥n</button>
  </form>
</section>

<style>
.cotizacion-page {
  padding: 3rem 1rem;
  max-width: 1200px;
  margin: 0 auto;
}

.text-center {
  text-align: center;
}

/* Controles */
.cotizacion-controls {
  max-width: 400px;
  margin: 0 auto;
}

.search-input {
  width: 100%;
  padding: 0.75rem 1rem;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  font-size: 1rem;
}

.search-input:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* Contador de seleccionados */
.selected-counter {
  background: #f0f9ff;
  border: 1px solid #bae6fd;
  border-radius: 8px;
  padding: 12px 16px;
  text-align: center;
  font-weight: 500;
  color: #0369a1;
}

.clear-btn {
  background: none;
  border: none;
  color: #dc2626;
  cursor: pointer;
  margin-left: 12px;
  font-size: 0.875rem;
}

.clear-btn:hover {
  text-decoration: underline;
}

/* Grid de productos */
.product-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.product-card {
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  padding: 1.25rem;
  text-align: center;
  background-color: #fff;
  transition: all 0.3s ease;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  position: relative;
}

.product-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 15px -3px rgba(0, 0, 0, 0.1);
  border-color: #3b82f6;
}

.product-card.selected {
  border-color: #3b82f6;
  background-color: #f0f9ff;
}

.product-card img {
  width: 100%;
  height: 160px;
  object-fit: cover;
  border-radius: 8px;
  margin-bottom: 0.75rem;
}

.product-card h3 {
  font-size: 1rem;
  margin: 0.5rem 0;
  font-weight: 600;
  color: #1f2937;
  line-height: 1.4;
}

.product-card .product-price {
  color: #059669;
  font-weight: 600;
  margin-bottom: 0.75rem;
}

.checkbox-container {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  margin-top: 0.5rem;
}

.checkbox-container input[type="checkbox"] {
  transform: scale(1.2);
  margin-right: 0.5rem;
}

/* Paginaci√≥n */
.pagination-controls {
  margin-top: 2rem;
}

.pagination-btn {
  padding: 0.5rem 1rem;
  background-color: white;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
  font-weight: 500;
}

.pagination-btn:hover:not(:disabled) {
  background-color: #f3f4f6;
  border-color: #9ca3af;
}

.pagination-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.page-numbers {
  display: flex;
  gap: 0.5rem;
}

.page-number {
  padding: 0.5rem 0.75rem;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
}

.page-number:hover {
  background-color: #f3f4f6;
}

.page-number.active {
  background-color: #3b82f6;
  color: white;
}

/* Formulario */
.cotizacion-form {
  background-color: #f9fafb;
  border-radius: 12px;
  padding: 2rem;
  max-width: 500px;
  margin: 0 auto;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.form-group {
  margin-bottom: 1rem;
}

.form-label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
  color: #374151;
}

.form-input, .form-textarea {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  font-size: 1rem;
  transition: border-color 0.2s;
}

.form-input:focus, .form-textarea:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-textarea {
  min-height: 100px;
  resize: vertical;
}

/* Botones */
.btn {
  display: inline-block;
  padding: 0.75rem 1.5rem;
  border-radius: 8px;
  font-weight: 600;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s ease;
  border: none;
  font-size: 1rem;
}

.btn--primary {
  background-color: #2563eb;
  color: white;
}

.btn--primary:hover {
  background-color: #1d4ed8;
  transform: translateY(-1px);
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

/* Responsive */
@media (max-width: 768px) {
  .product-grid {
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1rem;
  }
  
  .cotizacion-form {
    padding: 1.5rem;
  }
  
  .pagination-controls {
    flex-wrap: wrap;
  }
  
  .page-numbers {
    order: -1;
    width: 100%;
    justify-content: center;
    margin-bottom: 1rem;
  }
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
  // Variables globales
  let allProducts = [];
  let filteredProducts = [];
  let currentPage = 1;
  const productsPerPage = 12;
  
  // Elementos DOM
  const productsContainer = document.getElementById('cotizacion-productos');
  const searchInput = document.getElementById('product-search');
  const prevButton = document.getElementById('prev-page');
  const nextButton = document.getElementById('next-page');
  const pageNumbersContainer = document.getElementById('page-numbers');
  const selectedCounter = document.getElementById('selected-counter');
  const selectedCount = document.getElementById('selected-count');
  const clearSelectionButton = document.getElementById('clear-selection');
  const form = document.getElementById('cotizacion-form');
  
  // Cargar productos
  fetch('/products.json?limit=250')
    .then(function(res) {
      if (!res.ok) throw new Error('Error al cargar productos');
      return res.json();
    })
    .then(function(data) {
      allProducts = data.products;
      filteredProducts = allProducts.slice();
      renderProducts();
      setupEventListeners();
    })
    .catch(function(error) {
      console.error('Error:', error);
      productsContainer.innerHTML = '<p class="text-center text-red-500">Error al cargar los productos. Por favor, recarga la p√°gina.</p>';
    });
  
  // Renderizar productos
  function renderProducts() {
    const startIndex = (currentPage - 1) * productsPerPage;
    const endIndex = startIndex + productsPerPage;
    const productsToShow = filteredProducts.slice(startIndex, endIndex);
    
    productsContainer.innerHTML = productsToShow.map(function(product) {
      const isSelected = localStorage.getItem('selected_' + product.id) === 'true';
      return `
        <div class="product-card ${isSelected ? 'selected' : ''}">
          <img src="${product.images[0]?.src || '//via.placeholder.com/200x160?text=Sin+imagen'}" 
               alt="${product.title}" 
               loading="lazy"
               onerror="this.src='//via.placeholder.com/200x160?text=Sin+imagen'">
          <h3>${product.title}</h3>
          <div class="product-price">${formatPrice(product.variants[0]?.price)}</div>
          <div class="checkbox-container">
            <input type="checkbox" 
                   id="product-${product.id}" 
                   value="${product.id}" 
                   ${isSelected ? 'checked' : ''}
                   data-title="${product.title}">
            <label for="product-${product.id}">Seleccionar</label>
          </div>
        </div>
      `;
    }).join('');
    
    updatePagination();
    updateSelectedCounter();
  }
  
  // Formatear precio
  function formatPrice(price) {
    if (!price) return 'Consultar precio';
    return '$' + parseFloat(price).toFixed(2);
  }
  
  // Actualizar paginaci√≥n
  function updatePagination() {
    const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
    
    // Botones anterior/siguiente
    prevButton.disabled = currentPage === 1;
    nextButton.disabled = currentPage === totalPages || totalPages === 0;
    
    // N√∫meros de p√°gina
    pageNumbersContainer.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    const maxPages = 5;
    let startPage = Math.max(1, currentPage - 2);
    let endPage = Math.min(totalPages, startPage + maxPages - 1);
    
    if (endPage - startPage < maxPages - 1) {
      startPage = Math.max(1, endPage - maxPages + 1);
    }
    
    for (let i = startPage; i <= endPage; i++) {
      const pageButton = document.createElement('button');
      pageButton.className = 'page-number' + (i === currentPage ? ' active' : '');
      pageButton.textContent = i;
      pageButton.addEventListener('click', function() {
        currentPage = i;
        renderProducts();
      });
      pageNumbersContainer.appendChild(pageButton);
    }
  }
  
  // Actualizar contador de seleccionados
  function updateSelectedCounter() {
    let count = 0;
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key && key.startsWith('selected_') && localStorage.getItem(key) === 'true') {
        count++;
      }
    }
    
    selectedCount.textContent = count;
    
    if (count > 0) {
      selectedCounter.style.display = 'block';
    } else {
      selectedCounter.style.display = 'none';
    }
  }
  
  // Configurar event listeners
  function setupEventListeners() {
    // B√∫squeda
    searchInput.addEventListener('input', function(e) {
      const searchTerm = e.target.value.toLowerCase();
      filteredProducts = allProducts.filter(function(product) {
        return product.title.toLowerCase().includes(searchTerm);
      });
      currentPage = 1;
      renderProducts();
    });
    
    // Paginaci√≥n
    prevButton.addEventListener('click', function() {
      if (currentPage > 1) {
        currentPage--;
        renderProducts();
      }
    });
    
    nextButton.addEventListener('click', function() {
      const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        renderProducts();
      }
    });
    
    // Selecci√≥n de productos
    productsContainer.addEventListener('change', function(e) {
      if (e.target.type === 'checkbox') {
        const productId = e.target.value;
        const isChecked = e.target.checked;
        
        localStorage.setItem('selected_' + productId, isChecked);
        
        // Actualizar estilo de la tarjeta
        const card = e.target.closest('.product-card');
        if (isChecked) {
          card.classList.add('selected');
        } else {
          card.classList.remove('selected');
        }
        
        updateSelectedCounter();
      }
    });
    
    // Limpiar selecci√≥n
    clearSelectionButton.addEventListener('click', function() {
      // Limpiar solo las selecciones de productos
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('selected_')) {
          localStorage.removeItem(key);
        }
      }
      renderProducts();
    });
    
    // Env√≠o del formulario
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Obtener productos seleccionados
      const selectedProducts = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('selected_') && localStorage.getItem(key) === 'true') {
          const productId = key.replace('selected_', '');
          const product = allProducts.find(function(p) { return p.id == productId; });
          if (product) {
            selectedProducts.push(product.title);
          }
        }
      }
      
      if (selectedProducts.length === 0) {
        alert('Por favor, selecciona al menos un producto para solicitar cotizaci√≥n.');
        return;
      }
      
      const nombre = form.nombre.value;
      const email = form.email.value;
      const mensaje = form.mensaje.value;

      const texto = encodeURIComponent(
        'Nueva solicitud de cotizaci√≥n:\n\n' +
        'Cliente: ' + nombre + '\n' +
        'Email: ' + email + '\n\n' +
        'Equipos seleccionados:\n' + selectedProducts.join('\n') + '\n\n' +
        'Detalles:\n' + mensaje
      );

      window.open('https://wa.me/34600000000?text=' + texto, '_blank');
    });
  }
  
  // Inicializar contador al cargar
  updateSelectedCounter();
});
</script>

{% schema %}
{
  "name": "P√°gina de cotizaci√≥n",
  "settings": []
}
{% endschema %}